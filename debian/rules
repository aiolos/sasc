#!/usr/bin/make -f

include debian/rules.defs

SHELL := /bin/bash

%:
	if [ -e debian/control ]; then \
		dh $@; \
	else \
		$(MAKE) -f debian/rules debian/control; \
	fi

override_dh_installinit:
	dh_installinit --name sasc-ng

override_dh_auto_configure:
	# done per binary package in build-% rule
	
override_dh_auto_clean:
	cd contrib/sasc-ng; if [ -r config.mak ]; then make clean module_clean; fi
	
override_dh_auto_build:
	#cd contrib/sasc-ng; make module; make

# build_(kernel)_(flavor), e.g. build_3.7.trunk-amd64_sse2
build_%:
	VERSION="$*"; \
	FLAVOR=$${VERSION#*_}; \
	KERNEL=$${VERSION/_$$FLAVOR/}; \
	sed -e "s|#DVB_DIR#|$(CURDIR)/debian/includes/$$KERNEL/|" < debian/config.mak-$$FLAVOR > contrib/sasc-ng/config.mak; \
	echo "Building $$VERSION - $$FLAVOR"; \
	cd contrib/sasc-ng; \
	make module; \
	make; \
	mkdir -p $(CURDIR)/debian/tmp/$$KERNEL-$$FLAVOR/bin; \
	mkdir -p $(CURDIR)/debian/tmp/$$KERNEL-$$FLAVOR/modules; \
	mkdir -p $(CURDIR)/debian/tmp/$$KERNEL-$$FLAVOR/lib; \
	install -m0755 sasc-ng $(CURDIR)/debian/tmp/$$KERNEL-$$FLAVOR/bin/; \
	install -m0644 dvbloopback.ko $(CURDIR)/debian/tmp/$$KERNEL-$$FLAVOR/modules; \
	install -m0644 sc/PLUGINS/lib/* $(CURDIR)/debian/tmp/$$KERNEL-$$FLAVOR/lib/; \
	make module_clean; \
	make clean

override_dh_auto_install: $(foreach kernel,$(KERNELS),$(foreach flav,$(FFDECSA_FLAVORS),build_$(kernel)_$(flav)))
	# use (package).install instead

CONTROL_FILES    = debian/control.source debian/control.flavor debian/rules debian/rules.defs debian/sasc-ng.install.in
comma            = ,

debian/control: $(CONTROL_FILES)
ifeq ($(wildcard debian/control.md5sum),)
	$(MAKE) -f debian/rules debian/control-real
else
	md5sum --check debian/control.md5sum --status || \
		$(MAKE) -f debian/rules debian/control-real
endif

LINUX_HEADERS    =$(foreach f,$(KERNELS),linux-headers-$(f) (=$(KERNEL_VERSION_$(f)))$(comma))

# call with $1 = kernel version, $2 = full kernel version, $3 = flavor
define append-flavor-entries
	sed \
		-e 's/#KERNEL#/$1/g' \
		-e 's/#KERNEL_VERSION#/$2/g' \
		-e 's/#FLAVOR#/$3/g' \
		debian/control.flavor >> debian/control.tmp

endef

# call with $1 = kernel version, $2 = flavor
define create-flavor-install
	 sed -e 's/#KERNEL#/$1/g' \
	     -e 's/#FLAVOR#/$2/g' \
		debian/sasc-ng.install.in > debian/sasc-ng-$1-$2.install

endef

debian/control-real: $(CONTROL_FILES)
	sed \
		-e 's/#LINUX_HEADERS#/$(LINUX_HEADERS)/g' \
		debian/control.source > debian/control.tmp
	$(foreach f,$(KERNELS),$(call append-flavor-entries,$(f),$(KERNEL_VERSION_$(f)),sse2))
	mv debian/control.tmp debian/control
	$(foreach kernel,$(KERNELS),$(foreach flav,$(FFDECSA_FLAVORS),$(call create-flavor-install,$(kernel),$(flav))))
	md5sum debian/control $^ > debian/control.md5sum
	@echo
	@echo This target is made to fail intentionally, to make sure
	@echo that it is NEVER run during the automated build. Please
	@echo ignore the following error, the debian/control file has
	@echo been generated SUCCESSFULLY.
	@echo
	exit 1

